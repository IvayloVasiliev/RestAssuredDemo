# GitHub Actions CI/CD Pipeline for API Automation Testing
# This workflow runs tests on every push and pull request
# Generates reports and uploads artifacts

name: API Automation Tests CI/CD Pipeline

# Trigger conditions
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

# Environment variables
env:
  JAVA_VERSION: '21'
  MAVEN_VERSION: '3.9.0'

jobs:
  test:
    name: Run API Tests
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # Step 2: Set up Java
    - name: Set up Java JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    # Step 3: Display Java and Maven versions
    - name: Display Java and Maven Versions
      run: |
        echo "Java Version:"
        java -version
        echo "Maven Version:"
        mvn --version

    # Step 4: Build the project
    - name: Build Project with Maven
      run: mvn clean compile
      continue-on-error: false

    # Step 5: Run API tests
    - name: Run API Automation Tests
      run: mvn test -DsuiteXmlFile=src/test/resources/testng.xml
      continue-on-error: true

    # Step 6: Generate Allure Report
    - name: Generate Allure Report
      if: always()
      run: |
        mvn allure:report
      continue-on-error: true

    # Step 7: Publish Test Results
    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: target/surefire-reports/*.xml
        check_name: API Test Results
        comment_mode: always

    # Step 8: Upload Allure Report as Artifact
    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-report-${{ github.run_number }}
        path: target/site/allure-maven-plugin/
        retention-days: 30

    # Step 9: Upload Test Results as Artifact
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ github.run_number }}
        path: target/surefire-reports/
        retention-days: 30

    # Step 10: Upload Maven Build Log
    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-log-${{ github.run_number }}
        path: target/
        retention-days: 30

    # Step 11: Test Summary
    - name: Test Execution Summary
      if: always()
      run: |
        echo "═══════════════════════════════════════════════════════"
        echo "Test Execution Summary"
        echo "═══════════════════════════════════════════════════════"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run Number: ${{ github.run_number }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Actor: ${{ github.actor }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "═══════════════════════════════════════════════════════"

  # Deploy reports to GitHub Pages (optional)
  deploy-report:
    name: Deploy Report to GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
    - name: Download Allure Report
      uses: actions/download-artifact@v3
      with:
        name: allure-report-${{ github.run_number }}
        path: allure-report

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./allure-report
        destination_dir: reports/${{ github.run_number }}
      continue-on-error: true

